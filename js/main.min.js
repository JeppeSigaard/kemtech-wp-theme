var ajaxURL = $('meta[name="ajax-url"]').attr('content');
$('meta[name=ajax-url]').remove();

// @koala-append 'assets/viewport.js';
// @koala-append 'assets/autosize.js';
// @koala-append 'assets/js.cookie.js';
// @koala-append 'assets/styledselect.js';
// @koala-append 'assets/putCursorAtEnd.js';

// @koala-append 'components/data-img.js';
// @koala-append 'components/form.js';
// @koala-append 'components/is.js';
// @koala-append 'components/jshtml.js';



// @koala-append 'modules/toggle-menu.js';
// @koala-append 'modules/product-search.js';
// @koala-append 'modules/sync-scroll.js';

/*
 * Viewport - jQuery selectors for finding elements in viewport
 *
 * Copyright (c) 2008-2009 Mika Tuupola
 *
 * Licensed under the MIT license:
 *   http://www.opensource.org/licenses/mit-license.php
 *
 * Project home:
 *  http://www.appelsiini.net/projects/viewport
 *
 */
(function($) {
    
    $.belowthefold = function(element, settings) {
        var fold = $(window).height() + $(window).scrollTop();
        return fold <= $(element).offset().top - settings.threshold;
    };

    $.abovethetop = function(element, settings) {
        var top = $(window).scrollTop();
        return top >= $(element).offset().top + $(element).height() - settings.threshold;
    };
    
    $.rightofscreen = function(element, settings) {
        var fold = $(window).width() + $(window).scrollLeft();
        return fold <= $(element).offset().left - settings.threshold;
    };
    
    $.leftofscreen = function(element, settings) {
        var left = $(window).scrollLeft();
        return left >= $(element).offset().left + $(element).width() - settings.threshold;
    };
    
    $.inviewport = function(element, settings) {
        return !$.rightofscreen(element, settings) && !$.leftofscreen(element, settings) && !$.belowthefold(element, settings) && !$.abovethetop(element, settings);
    };
    
    $.extend($.expr[':'], {
        "below-the-fold": function(a, i, m) {
            return $.belowthefold(a, {threshold : 0});
        },
        "above-the-top": function(a, i, m) {
            return $.abovethetop(a, {threshold : 0});
        },
        "left-of-screen": function(a, i, m) {
            return $.leftofscreen(a, {threshold : 0});
        },
        "right-of-screen": function(a, i, m) {
            return $.rightofscreen(a, {threshold : 0});
        },
        "in-viewport": function(a, i, m) {
            return $.inviewport(a, {threshold : 0});
        }
    });

    
})(jQuery);

(function (root, factory) {
	'use strict';

	if (typeof define === 'function' && define.amd) {
		// AMD. Register as an anonymous module.
		define([], factory);
	} else if (typeof exports === 'object') {
		// Node. Does not work with strict CommonJS, but
		// only CommonJS-like environments that support module.exports,
		// like Node.
		module.exports = factory();
	} else {
		// Browser globals (root is window)
		root.autosize = factory();
  }
}(this, function () {
	function main(ta) {
		if (!ta || !ta.nodeName || ta.nodeName !== 'TEXTAREA' || ta.hasAttribute('data-autosize-on')) { return; }

		var maxHeight;
		var heightOffset;

		function init() {
			var style = window.getComputedStyle(ta, null);

			if (style.resize === 'vertical') {
				ta.style.resize = 'none';
			} else if (style.resize === 'both') {
				ta.style.resize = 'horizontal';
			}

			// horizontal overflow is hidden, so break-word is necessary for handling words longer than the textarea width
			ta.style.wordWrap = 'break-word';

			// Chrome/Safari-specific fix:
			// When the textarea y-overflow is hidden, Chrome/Safari doesn't reflow the text to account for the space
			// made available by removing the scrollbar. This workaround will cause the text to reflow.
			var width = ta.style.width;
			ta.style.width = '0px';
			// Force reflow:
			/* jshint ignore:start */
			ta.offsetWidth;
			/* jshint ignore:end */
			ta.style.width = width;

			maxHeight = style.maxHeight !== 'none' ? parseFloat(style.maxHeight) : false;

			if (style.boxSizing === 'content-box') {
				heightOffset = -(parseFloat(style.paddingTop)+parseFloat(style.paddingBottom));
			} else {
				heightOffset = parseFloat(style.borderTopWidth)+parseFloat(style.borderBottomWidth);
			}

			adjust();
		}

		function adjust() {
			var startHeight = ta.style.height;
			var htmlTop = document.documentElement.scrollTop;
			var bodyTop = document.body.scrollTop;

			ta.style.height = 'auto';

			var endHeight = ta.scrollHeight+heightOffset;

			if (maxHeight !== false && maxHeight < endHeight) {
				endHeight = maxHeight;
				if (ta.style.overflowY !== 'scroll') {
					ta.style.overflowY = 'scroll';
				}
			} else if (ta.style.overflowY !== 'hidden') {
				ta.style.overflowY = 'hidden';
			}

			ta.style.height = endHeight+'px';

			// prevents scroll-position jumping
			document.documentElement.scrollTop = htmlTop;
			document.body.scrollTop = bodyTop;

			if (startHeight !== ta.style.height) {
				var evt = document.createEvent('Event');
				evt.initEvent('autosize.resized', true, false);
				ta.dispatchEvent(evt);
			}
		}

		// IE9 does not fire onpropertychange or oninput for deletions,
		// so binding to onkeyup to catch most of those events.
		// There is no way that I know of to detect something like 'cut' in IE9.
		if ('onpropertychange' in ta && 'oninput' in ta) {
			ta.addEventListener('keyup', adjust);
		}

		window.addEventListener('resize', adjust);
		ta.addEventListener('input', adjust);

		ta.addEventListener('autosize.update', adjust);

		ta.addEventListener('autosize.destroy', function(style){
			window.removeEventListener('resize', adjust);
			ta.removeEventListener('input', adjust);
			ta.removeEventListener('keyup', adjust);
			ta.removeEventListener('autosize.destroy');

			Object.keys(style).forEach(function(key){
				ta.style[key] = style[key];
			});

			ta.removeAttribute('data-autosize-on');
		}.bind(ta, {
			height: ta.style.height,
			overflow: ta.style.overflow,
			overflowY: ta.style.overflowY,
			wordWrap: ta.style.wordWrap,
			resize: ta.style.resize
		}));

		ta.setAttribute('data-autosize-on', true);
		ta.style.overflow = 'hidden';
		ta.style.overflowY = 'hidden';

		init();
	}

	// Do nothing in IE8 or lower
	if (typeof window.getComputedStyle !== 'function') {
		return function(elements) {
			return elements;
		};
	} else {
		return function(elements) {
			if (elements && elements.length) {
				Array.prototype.forEach.call(elements, main);
			} else if (elements && elements.nodeName) {
				main(elements);
			}
			return elements;
		};
	}
}));


/*!
 * Javascript Cookie v1.5.1
 * https://github.com/js-cookie/js-cookie
 *
 * Copyright 2006, 2014 Klaus Hartl
 * Released under the MIT license
 */
(function (factory) {
	var jQuery;
	if (typeof define === 'function' && define.amd) {
		// AMD (Register as an anonymous module)
		define(['jquery'], factory);
	} else if (typeof exports === 'object') {
		// Node/CommonJS
		try {
			jQuery = require('jquery');
		} catch(e) {}
		module.exports = factory(jQuery);
	} else {
		// Browser globals
		var _OldCookies = window.Cookies;
		var api = window.Cookies = factory(window.jQuery);
		api.noConflict = function() {
			window.Cookies = _OldCookies;
			return api;
		};
	}
}(function ($) {

	var pluses = /\+/g;

	function encode(s) {
		return api.raw ? s : encodeURIComponent(s);
	}

	function decode(s) {
		return api.raw ? s : decodeURIComponent(s);
	}

	function stringifyCookieValue(value) {
		return encode(api.json ? JSON.stringify(value) : String(value));
	}

	function parseCookieValue(s) {
		if (s.indexOf('"') === 0) {
			// This is a quoted cookie as according to RFC2068, unescape...
			s = s.slice(1, -1).replace(/\\"/g, '"').replace(/\\\\/g, '\\');
		}

		try {
			// Replace server-side written pluses with spaces.
			// If we can't decode the cookie, ignore it, it's unusable.
			// If we can't parse the cookie, ignore it, it's unusable.
			s = decodeURIComponent(s.replace(pluses, ' '));
			return api.json ? JSON.parse(s) : s;
		} catch(e) {}
	}

	function read(s, converter) {
		var value = api.raw ? s : parseCookieValue(s);
		return isFunction(converter) ? converter(value) : value;
	}

	function extend() {
		var key, options;
		var i = 0;
		var result = {};
		for (; i < arguments.length; i++) {
			options = arguments[ i ];
			for (key in options) {
				result[key] = options[key];
			}
		}
		return result;
	}

	function isFunction(obj) {
		return Object.prototype.toString.call(obj) === '[object Function]';
	}

	var api = function (key, value, options) {

		// Write

		if (arguments.length > 1 && !isFunction(value)) {
			options = extend(api.defaults, options);

			if (typeof options.expires === 'number') {
				var days = options.expires, t = options.expires = new Date();
				t.setMilliseconds(t.getMilliseconds() + days * 864e+5);
			}

			return (document.cookie = [
				encode(key), '=', stringifyCookieValue(value),
				options.expires ? '; expires=' + options.expires.toUTCString() : '', // use expires attribute, max-age is not supported by IE
				options.path    ? '; path=' + options.path : '',
				options.domain  ? '; domain=' + options.domain : '',
				options.secure  ? '; secure' : ''
			].join(''));
		}

		// Read

		var result = key ? undefined : {},
			// To prevent the for loop in the first place assign an empty array
			// in case there are no cookies at all. Also prevents odd result when
			// calling "get()".
			cookies = document.cookie ? document.cookie.split('; ') : [],
			i = 0,
			l = cookies.length;

		for (; i < l; i++) {
			var parts = cookies[i].split('='),
				name = decode(parts.shift()),
				cookie = parts.join('=');

			if (key === name) {
				// If second argument (value) is a function it's a converter...
				result = read(cookie, value);
				break;
			}

			// Prevent storing a cookie that we couldn't decode.
			if (!key && (cookie = read(cookie)) !== undefined) {
				result[name] = cookie;
			}
		}

		return result;
	};

	api.get = api.set = api;
	api.defaults = {};

	api.remove = function (key, options) {
		// Must not alter options, thus extending a fresh object...
		api(key, '', extend(options, { expires: -1 }));
		return !api(key);
	};

	if ( $ ) {
		$.cookie = api;
		$.removeCookie = api.remove;
	}

	return api;
}));


/*
Reference: http://jsfiddle.net/BB3JK/47/
*/

$('select').each(function(){
    var $this = $(this), numberOfOptions = $(this).children('option').length;

    $this.addClass('select-hidden');
    $this.wrap('<div class="select"></div>');
    $this.after('<div class="select-styled"></div>');

    var $styledSelect = $this.next('div.select-styled');
    $styledSelect.text($this.children('option').eq(0).text());

    var $list = $('<ul />', {
        'class': 'select-options'
    }).insertAfter($styledSelect);

    for (var i = 0; i < numberOfOptions; i++) {
        $('<li />', {
            text: $this.children('option').eq(i).text(),
            rel: $this.children('option').eq(i).val()
        }).appendTo($list);
    }

    var $listItems = $list.children('li');

    $styledSelect.click(function(e) {
        e.stopPropagation();
        $(this).parent('.select').next('label').addClass('stayup');

        $('div.select-styled.active').each(function(){
            $(this).removeClass('active').next('ul.select-options').hide();

        });
        $(this).toggleClass('active').next('ul.select-options').toggle();
    });

    $listItems.click(function(e) {
        e.stopPropagation();
        $styledSelect.text($(this).text()).removeClass('active').addClass('success');
        $this.val($(this).attr('rel'));
        $list.hide();
        //console.log($this.val());
    });

    $(document).click(function() {
        $styledSelect.removeClass('active');
        $list.hide();
    });

});


jQuery.fn.putCursorAtEnd = function() {

  return this.each(function() {

    $(this).focus()

    // If this function exists...
    if (this.setSelectionRange) {
      // ... then use it (Doesn't work in IE)

      // Double the length because Opera is inconsistent about whether a carriage return is one character or two. Sigh.
      var len = $(this).val().length * 2;

      this.setSelectionRange(len, len);
    
    } else {
    // ... otherwise replace the contents with itself
    // (Doesn't work in Google Chrome)

      $(this).val($(this).val());
      
    }

    // Scroll to the bottom, in case we're in a tall textarea
    // (Necessary for Firefox and Google Chrome)
    this.scrollTop = 999999;

  });

};

// Load images into placeholders
// Use data-bg="" on any element to async load an image background
// Use data-src="" on images to async load an image src


var loadDataImages = function(){
    
    // For each background placeholder
    $('[data-bg]').each(function(e){
        
            // grab 'this', the data-bg attribute and make a new placeholder image object
            var $img = $(this),
                $imgSrc = $(this).attr('data-bg'),
                $imgPlaceholder = new Image();
            
            // render background into local storage by applying it to the placeholder
            $imgPlaceholder.src = $imgSrc;
            
            // When the placeholder is loaded
            $imgPlaceholder.onload = function(){
                
                // Apply the source to 'this', hide 'this' and fade it in
                $img.removeAttr('data-bg').removeClass('loading').css({
                    backgroundImage: 'url('+$imgSrc+')',
                });
            };
        });
        
    
        // Basically same thing with images
        
        
        $('img[data-src]').each(function(e){
            
            var $img = $(this),
                $imgSrc = $(this).attr('data-src'),
                $imgPlaceholder = new Image();
            
            $imgPlaceholder.src = $imgSrc;
            $imgPlaceholder.onload = function(){
                $img.removeAttr('data-src').removeClass('loading').attr('src',$imgSrc);
            };
        });


}

// Run on load (and use in other scripts as needed)
$(window).on('load',function(){
    loadDataImages();
});


var checkSuccess = function(target){

    if(target.val() === ''){target.removeClass('success').next('label').removeClass('stayup');}

    else if(target.is('input[type="checkbox"], input[type="radio"]')){}

    else{target.addClass('success').next('label').addClass('stayup');}

}

var formHandleResponse = function(response,form){

    form.removeClass('loading');
    
    $.event.trigger({
        type : "formReturn",
        response : response,
        target : form,
    });

}

var validateForm = function(form){

    var ready = true;

    form.find('input').each(function(){

        if($(this).hasClass('error')){
            ready = false;
        }

		if($(this).is(':required') || $(this).hasClass('required') && $(this).val() === ''){
			$(this).removeClass('success').addClass('error');
			ready = false;
		}

    });

    if (ready){
        return true;
    }
    else{
        return false
    }
}

var validateEmail = function(email) {
    var re = /^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i;
    return re.test(email);
}

var formJsInit = function(){

    $('form input, form textarea').each(function(){
        checkSuccess($(this));
    });

    autosize($('form textarea:not(.no-autosize)'));

    // Check for allerede udfyldt felter ved sideload
    $('form input, form textarea').each(function(){
        var target = $(this);
        checkSuccess(target);
    });

    // Kosmetisk opdatering ved blur
    $('form input, form textarea').off().on('blur',function(e){
        var target = $(e.target);

        // Fjern error
        target.removeClass('error');

        // Check om feltet er tomt
        checkSuccess(target);

        if(target.is('input[type="email"]') && target.val() !== ''){

            if(!validateEmail(target.val())){

                target.addClass('error');
            }


        }

    });


    $('form').off().on({

        keyup : function(e){

            var target = $(e.target);

            // Fjern error og success
            target.removeClass('error').removeClass('success');

            if(target.is('input[type="number"]')){

                var value = target.val().replace(/[^0-9]/g, '');

                target.val(value);

            }
            
            if(target.is('input[data-restrict="true"]')){
                
                var value = target.val().replace(/[^0-9a-zA-ZÆØÅæøå ]/g, '');

                target.val(value);
                
            }

        },

        click : function(e){
            var t = $(e.target);

            if(t.is('.submit')){
                e.preventDefault();


                var form = t.parents('form'),
                    action = form.attr('action'),
                    formData = form.serialize();

                if(validateForm(form) && !form.hasClass('loading') && !form.hasClass('success')){

                    form.addClass('loading');

                    $.ajax({
                        url : action,
                        type : 'POST',
                        data : formData,
                        dataType : 'json',
                        success : function(response){
                            formHandleResponse(response,form);
                        },
                    });

                }
            }
        }
     });

}

$(function(){

    formJsInit();

});


function is_mobile(){
    return $('body').hasClass('is-mobile');
};

function is_touch_device() {
  return 'ontouchstart' in window || navigator.maxTouchPoints;
};

function jshtml(tagname,attributes,content){
    var ret = '<' + tagname,
        lineBreaks = false;
    
    if (attributes.lineBreaks === true){
        lineBreaks = true;
    }
    
    for (var k in attributes){
        if (attributes.hasOwnProperty(k) && k !== 'lineBreaks') {
            ret += ' '+ k + '="' +attributes[k]+ '"';   
        }
    }
    
    if(typeof content !== 'undefined'){
    
        if ($.isArray(content)){
            ret +=  '>';
            
            content.forEach(function(e){
                ret += '\n' + e;        
            });
            
            ret += '\n</' + tagname + '>';;
        }
        
        else if (lineBreaks){ret += '>' + content.replace(/(?:\r\n|\r|\n)/g, '<br />') + '</' + tagname + '>';}
        
        else{ ret += '>' + content + '</' + tagname + '>';}
    }

    else{ ret += '/>';}
    
    return ret;
};

$('.header-hamburger').on('click',function(){
    
    $('body').toggleClass('show-menu');
    
});

var prodSearch = {
    
    titles : {},
    data : {},
    
    substringMatcher : function(strs,q) {
        var matches, substringRegex;
        matches = [];
        substrRegex = new RegExp(q, 'i');
        $.each(strs, function(i, str) {
            if (substrRegex.test(str)) {
                matches.push(i);
            }
        });
        return matches;
    },
    
    fetchProducts : function(complete){
        $.ajax({
            url : ajaxURL,
            type : 'POST',
            data : 'action=fetch-products',
            dataType : 'json',
            success : function(response){
                if (response.data){
                    prodSearch.data = response.data;
                    prodSearch.titles = response.titles;
                } 
                if(typeof complete === 'function'){
                    complete(response);
                }
            },
        });
    },
    
    makeNode : function(id,term){
        var data = prodSearch.data[id],
            
            img = jshtml('img',{src: data.img}),
            imgContainer = jshtml('div',{class : 'result-img'},[img]),
            
            header = jshtml('h3',{class: 'result-title',} , prodSearch.strHiglight(data.title, term)),
            desc = jshtml('div',{class: 'result-desc'},prodSearch.strHiglight(data.desc, term)),
            footer = jshtml('footer',{class: 'result-footer'},''),
            textContainer = jshtml('div',{class: 'result-text'}, [header,desc,footer]),
            
            linksContainer = jshtml('div',{class: 'result-links'},''),
            
            containerInner = jshtml('div',{class: 'inner'}, [imgContainer, textContainer, linksContainer]);
            container = jshtml('a', {class: 'result result-'+id, href: data.permalink} , [containerInner] );
        
        return container;
    },
    
    strHiglight : function(str,hi){
        var substrRegex = new RegExp(hi,'i'),
            ret = str;
        if (substrRegex.test(str)) {
            var ret = str.replace(substrRegex,jshtml( 'span', {class: 'hilight'}, String(str.match(substrRegex))));
        }
        return ret;
    },
    
    keyup : function(){
        $('#product-search-form input[name="s"]').focus().on({
            
            keydown : function(e){
                
                if (e.keyCode === 9 && $('.search-results-container .result').length){
                    e.preventDefault();
                    $('.search-results-container .result:first-child').focus();

                }
                
            },
            
            keyup : function(e){
                var content = $(this).val(),
                    resultContainer = $('.search-results-container');
                if(content.length > 2){
                    prodSearch.spawnResults(content,resultContainer);
                }

            }
        });    
    },
    
    spawnResults : function(content,resultContainer){
        
        if(!$('.hero-banner').hasClass('search-mode')){
            $('.hero-banner').addClass('search-mode');
        }

        resultContainer.empty();

        var t = 0,
            maxRes = 10;

        // Søg på titler
        var titleMatches = prodSearch.substringMatcher(prodSearch.titles,content);
        titleMatches.forEach(function(i){
            t ++;
            if(t < maxRes){
                resultContainer.append(prodSearch.makeNode(i,content));
            }
        });
        
        // Søg på indhold
        var descriptions = [];
        for (var prop in prodSearch.data) {
            if( prodSearch.data.hasOwnProperty( prop ) ) {
                descriptions[prop] = prodSearch.data[prop].desc;
            } 
        }
        
        var descMatches = prodSearch.substringMatcher(descriptions,content);
        descMatches.forEach(function(i){
            t ++;
            if(t < maxRes){
                resultContainer.append(prodSearch.makeNode(i,content));
            }
        });
       
        
        // Afslut med en ingen resultater - box, hvis t = 0;
        if(t === 0){
            
            var span = jshtml('span',{},'Din søgning på "'+ content + '" gav ingen resultater.');
            resultContainer.append(jshtml('div',{class: 'search-no-results'},[span]));
        }
        
    },
}

// Do all this on load
$(function(){
    
    if($('#product-search-form').length){
        
        prodSearch.fetchProducts(function(){
            
            if(!is_touch_device()){
                prodSearch.keyup();
            }
            
            if($('input[name=s]').val().length > 2){
                prodSearch.spawnResults($('input[name=s]').val(),$('.search-results-container'));
                $('input[name=s]').putCursorAtEnd();
            }
            
            $('.submit-search').click(function(e){
                e.preventDefault();
                var content = $('input[name=s]').val(),
                    res = $('.search-results-container');
                
                if(content.length > 2 ){
                    prodSearch.spawnResults(content,res);
                }
            });
        });
    }
});

$(function(){if($('.fixed-aside').length){

    var lastScrollTop = 0,
        fancyScroll = $('.fixed-aside');

    
    
    $(window).on('scroll', function () {

        if($('.single-content').offset().top + $('.single-content').innerHeight() < $(window).scrollTop() + $(window).height()){
            fancyScroll.addClass('bottom');
        }
        
        else{
            
            fancyScroll.removeClass('bottom');
        }

        var st = $(this).scrollTop(),
            diff = st - lastScrollTop,
            scrollStop = $(window).innerHeight() + $(window).scrollTop(),
            fancyHeight = fancyScroll.offset().top + fancyScroll.innerHeight(),
            fancyScrollAmount = fancyScroll.scrollTop() + diff;

        if(fancyScroll.hasClass('bottom')){
        }
        
		else if($(window).width() > 768 && !fancyScroll.hasClass('bottom')){
            fancyScroll.scrollTop(fancyScrollAmount);
		}

		else{
			fancyScroll.scrollTop(0);
		}

		lastScrollTop = st;
    });
    
    $(window).load(function(){
        
        if($('.site-content').innerHeight() < $('.fixed-aside').innerHeight() && $(window).width() > 960){
        
            $('.site-content').css({
                height: $('.fixed-aside').innerHeight(),
            });

        }
        
    });

}});
